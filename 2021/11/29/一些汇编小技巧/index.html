<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>一些汇编小技巧 - MOEP0</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="MOEP0"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="MOEP0"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="写一些我自己不知道的汇编小技巧，持续更新。"><meta property="og:type" content="blog"><meta property="og:title" content="一些汇编小技巧"><meta property="og:url" content="https://moep0.github.io/2021/11/29/%E4%B8%80%E4%BA%9B%E6%B1%87%E7%BC%96%E5%B0%8F%E6%8A%80%E5%B7%A7/"><meta property="og:site_name" content="MOEP0"><meta property="og:description" content="写一些我自己不知道的汇编小技巧，持续更新。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://moep0.github.io/img/og_image.png"><meta property="article:published_time" content="2021-11-29T06:36:50.368Z"><meta property="article:modified_time" content="2021-11-29T07:05:03.980Z"><meta property="article:author" content="moep0"><meta property="article:tag" content="assembly"><meta property="article:tag" content="x86"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://moep0.github.io/2021/11/29/%E4%B8%80%E4%BA%9B%E6%B1%87%E7%BC%96%E5%B0%8F%E6%8A%80%E5%B7%A7/"},"headline":"一些汇编小技巧","image":["https://moep0.github.io/img/og_image.png"],"datePublished":"2021-11-29T06:36:50.368Z","dateModified":"2021-11-29T07:05:03.980Z","author":{"@type":"Person","name":"moep0"},"publisher":{"@type":"Organization","name":"MOEP0","logo":{"@type":"ImageObject","url":{"text":"MOEP0"}}},"description":"写一些我自己不知道的汇编小技巧，持续更新。"}</script><link rel="canonical" href="https://moep0.github.io/2021/11/29/%E4%B8%80%E4%BA%9B%E6%B1%87%E7%BC%96%E5%B0%8F%E6%8A%80%E5%B7%A7/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-SCXDJ5S6BG" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-SCXDJ5S6BG');</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">MOEP0</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-11-29T06:36:50.368Z" title="2021/11/29 下午2:36:50">2021-11-29</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-11-29T07:05:03.980Z" title="2021/11/29 下午3:05:03">2021-11-29</time></span><span class="level-item"><a class="link-muted" href="/categories/howto/">howto</a></span><span class="level-item">12 minutes read (About 1740 words)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><h1 class="title is-3 is-size-4-mobile">一些汇编小技巧</h1><div class="content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>写一些我自己不知道的汇编小技巧，持续更新。</p>
<span id="more"></span>
<h2 id="汇编预处理器指令（The-NASM-Preprocessor）">汇编预处理器指令（The NASM Preprocessor）</h2>
<p>本节主要以NASM指令和相关实例为主。如果想要了解更多NASM预处理器指令可以参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/alwaysking/p/12287529.html">这篇文章</a> 或者 <a target="_blank" rel="noopener" href="https://www.nasm.us/xdoc/2.11.08/html/nasmdoc0.html">NASM手册</a>。</p>
<h3 id="rep指令">rep指令</h3>
<p><code>rep</code> 指令可以将代码块重复若干次：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%rep</span> <span class="number">5</span>         </span><br><span class="line">   <span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line">   <span class="keyword">jnz</span> .next        </span><br><span class="line"><span class="meta">%endrep</span></span><br></pre></td></tr></table></figure>
<p>展开版本如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="keyword">jnz</span> .next</span><br><span class="line"></span><br><span class="line"><span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="keyword">jnz</span> .next</span><br><span class="line"></span><br><span class="line"><span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="keyword">jnz</span> .next</span><br><span class="line"></span><br><span class="line"><span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="keyword">jnz</span> .next</span><br><span class="line"></span><br><span class="line"><span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="keyword">jnz</span> .next</span><br></pre></td></tr></table></figure>
<h3 id="assign指令">assign指令</h3>
<p>assign指令用于向一个变量赋值，比如 <code>%assign i 100</code>，也可以将变量的值赋给它，比如 <code>%assign i i+1</code> 。</p>
<h3 id="实例">实例</h3>
<p>上面两个宏指令看上去很普通，但是我曾经在写benchmark的时候写过这种超级冗余的代码</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">r8</span>,<span class="number">100000</span></span><br><span class="line"><span class="meta">ALIGN</span> <span class="number">32</span></span><br><span class="line"><span class="symbol">.begin:</span></span><br><span class="line"><span class="symbol">.loop_1:</span></span><br><span class="line">	<span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line">	<span class="keyword">jge</span> .loop_2</span><br><span class="line"><span class="symbol">.loop_2:</span></span><br><span class="line">	<span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line">	<span class="keyword">jge</span> .loop_3</span><br><span class="line"><span class="symbol">.loop_3:</span></span><br><span class="line">	<span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line">	<span class="keyword">jge</span> .loop_4</span><br><span class="line"><span class="symbol">.loop_4:</span></span><br><span class="line"><span class="symbol">.loop_5:</span></span><br><span class="line">	<span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line">	<span class="keyword">jge</span> .loop_6</span><br><span class="line"><span class="comment">;...</span></span><br><span class="line"><span class="comment">;...</span></span><br><span class="line"><span class="symbol">.loop_8000:</span></span><br><span class="line"><span class="keyword">dec</span> <span class="built_in">r8</span></span><br><span class="line"><span class="keyword">jge</span> .begin</span><br></pre></td></tr></table></figure>
<p>有了 <code>rep</code> 和 <code>assign</code>，就可以把它变得很简洁了，从20007行减少到了12行…</p>
<p>当然前面那个也不是手写的，是程序生成的。但是下面这种写法还是方便很多</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">r8</span>,<span class="number">100000</span></span><br><span class="line"><span class="meta">ALIGN</span> <span class="number">32</span></span><br><span class="line"><span class="symbol">.begin:</span></span><br><span class="line"><span class="meta">%assign</span> i <span class="number">1</span> </span><br><span class="line"><span class="meta">%rep</span> <span class="number">7999</span></span><br><span class="line"><span class="meta">	.loop_</span>%+i</span><br><span class="line">	<span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line">	<span class="meta">%assign</span> i i+<span class="number">1</span></span><br><span class="line">	<span class="keyword">jge</span> .loop_%+i</span><br><span class="line"><span class="meta">%endrep</span></span><br><span class="line"><span class="symbol">.loop_8000:</span></span><br><span class="line"><span class="keyword">dec</span> <span class="built_in">r8</span></span><br><span class="line"><span class="keyword">jge</span> .begin</span><br></pre></td></tr></table></figure>
<h3 id="align-指令">align 指令</h3>
<p><code>align</code>指令主要用于对齐，可以加快汇编程序的运行速度。通常是添加 <code>nop</code> 达到对齐的目的。需要注意的是align指令后的数字必须是2的幂。</p>
<p>假定以下代码段从地址0（或者4的倍数）开始：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add</span> <span class="built_in">eax</span>,<span class="number">1</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ecx</span>,<span class="number">2</span></span><br><span class="line"><span class="meta">Align</span> <span class="number">4</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">edx</span>,<span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>那么它的等价表达就是</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span></span><br><span class="line"> <span class="keyword">add</span>    <span class="built_in">eax</span>,<span class="number">0x1</span> <span class="comment">;83 c0 01</span></span><br><span class="line"> <span class="keyword">add</span>    <span class="built_in">ecx</span>,<span class="number">0x2</span> <span class="comment">;83 c1 02</span></span><br><span class="line"> <span class="keyword">nop</span>            <span class="comment">;90</span></span><br><span class="line"> <span class="keyword">nop</span>            <span class="comment">;90</span></span><br><span class="line"> <span class="keyword">add</span>    <span class="built_in">edx</span>,<span class="number">0x3</span> <span class="comment">;83 c3 03</span></span><br></pre></td></tr></table></figure>
<p>其中 <code>align</code> 指令还可以使用 0 而不是 <code>nop</code> 作为填充，比如 <code>align  4,db 0</code>，它对应的机器码是 <code>0000</code> （ 对应的汇编指令是 <code>add  BYTE PTR [rax],al</code> ）。</p>
<p><code>alignb</code> 指令可以用于数据的对齐，作为性能优化的一种手段。</p>
<h3 id="comment">%comment</h3>
<p>可以使用<code>%comment</code> 和 <code>%endcomment</code> 来注释多行。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%comment</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">eax</span>,<span class="number">1</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ecx</span>,<span class="number">2</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">edx</span>,<span class="number">3</span></span><br><span class="line"><span class="meta">%endcomment</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="如何用shell脚本编译汇编程序">如何用shell脚本编译汇编程序</h2>
<p>只涉及编译汇编程序部分，更详细的论述请参考runoob教程。<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>
<p>使用shell脚本编译汇编程序的目的是为了多次测试汇编程序或者修改某些关键变量的值。</p>
<p>shell脚本中可以常规的进行赋值，也可以使用语句给变量赋值。在使用的时候只要加上 <code>$</code> 即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file = <span class="string">&quot;test.asm&quot;</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> `ls /etc`</span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> $(ls /etc)</span><br></pre></td></tr></table></figure>
<p>为了控制宏变量的值，我们需要使用 <code>for</code> 循环。以下两种格式都可以：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> item1 item2 ... itemN</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    command1</span><br><span class="line">    command2</span><br><span class="line">    ...</span><br><span class="line">    commandN</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> item1 item2 ... itemN; <span class="keyword">do</span> command1; command2… <span class="keyword">done</span>;</span><br></pre></td></tr></table></figure>
<p>在nasm中使用如下格式定义宏变量： <code> -Dmacro[=str]</code></p>
<p>所以一个完整的shell脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> NOPS <span class="keyword">in</span> $(seq 0 20) </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">	nasm -f elf64 test.asm -g -DNOPS=<span class="variable">$NOPS</span> -o test.o &amp;&amp; ld -m elf_x86_64 test.o -o <span class="built_in">test</span>  </span><br><span class="line"></span><br><span class="line">	<span class="built_in">echo</span> $(expr <span class="variable">$NOPS</span>); </span><br><span class="line"></span><br><span class="line">	perf -d ./<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>而在汇编程序内，需要有这样的指令，<code>nop</code> 就会被重复 <code>NOPS</code> 次了。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">times</span> NOPS <span class="keyword">nop</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="不知道该用在哪">不知道该用在哪</h2>
<p>首先介绍下 Code golf，指的是用<strong>尽可能短的源代码</strong>实现某种算法。</p>
<p>所以在实现时会出现很多奇怪的技巧（几乎都是用于减少汇编代码长度的）<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>，也许可以用在嵌入式里面。</p>
<h3 id="初始化eax">初始化eax</h3>
<p><strong>初始化 eax 为0</strong></p>
<p>当需要初始化 <code>eax</code> 为 0 的时候，不应该使用：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span>    <span class="built_in">eax</span>,<span class="number">0x0</span>  <span class="comment">;b8 00 00 00 00</span></span><br></pre></td></tr></table></figure>
<p>而应该使用</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">xor</span>    <span class="built_in">eax</span>,<span class="built_in">eax</span>  <span class="comment">;31 c0</span></span><br></pre></td></tr></table></figure>
<p>这节省了3 byte。当然还有其他的资源和能耗上的考量。<sup id="fnref:6"><a href="#fn:6" rel="footnote">6</a></sup> <sup id="fnref:7"><a href="#fn:7" rel="footnote">7</a></sup></p>
<p>查阅agner的手册可知，在Icelake上，<code>mov r, r/i</code> 和 <code>xor r, r/i</code> 的latency都是1周期，而reciprocal throughput都为0.25（可以并发处理4条独立的相同指令）。</p>
<p>但是如果考虑到CPU的乱序执行的话，<code>xor eax,eax</code> 使用了 <code>eax</code> 作为输入，那么是否存在数据依赖的风险从而导致指令被序列化执行呢？<sup id="fnref:8"><a href="#fn:8" rel="footnote">8</a></sup></p>
<p>考虑如下代码块：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add</span> <span class="built_in">eax</span>,<span class="number">1</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ebx</span>,<span class="built_in">eax</span></span><br><span class="line"><span class="keyword">xor</span> <span class="built_in">eax</span>,<span class="built_in">eax</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">eax</span>,<span class="built_in">ecx</span></span><br></pre></td></tr></table></figure>
<p>我们希望寄存器能够知道 <code>xor</code> 指令的结果并不依赖于 <code>add</code> 指令的结果。</p>
<p>从网上的存档来看，CPU可以做到的（由于找不到这么老的架构，我没有办法复现）。并且在sandybridge之后，intel引入了 zeroing idioms，许多常见的归零习语（zeroing idioms）被识别，并且寄存器被简单地设置为零。这些优化的完成速度与重命名期间的重命名速度相同（每个周期 4 µOP）。<sup id="fnref:9"><a href="#fn:9" rel="footnote">9</a></sup> 也就是说，<code>xor eax, eax</code> 甚至是不占用port资源的。</p>
<p><strong>初始化 eax 为 1</strong></p>
<p>当需要初始化 <code>eax</code> 为 1 的时候，也可以有类似的操作。需要注意的是 <code>dec eax</code>在64位中的机器码为 <code>ff c8</code>，而在32位中的机器码为 <code>48</code> 。</p>
<p>所以后两个表达在32位中是等价的，但是在64位中后面一个要节省一个byte。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span>    <span class="built_in">eax</span>,-<span class="number">1</span>          <span class="comment">;b8 ff ff ff ff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">xor</span>    <span class="built_in">eax</span>,<span class="built_in">eax</span>         <span class="comment">;31 c0</span></span><br><span class="line"><span class="keyword">dec</span>    <span class="built_in">eax</span>             <span class="comment">;ff c8 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span>     <span class="built_in">eax</span>,-<span class="number">1</span>          <span class="comment">;83 c8 ff</span></span><br></pre></td></tr></table></figure>
<p><strong>初始化 eax 为 全1</strong></p>
<p>根据peter cordes的答案，可以列出如下选项<sup id="fnref:10"><a href="#fn:10" rel="footnote">10</a></sup></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>, -<span class="number">1</span>         <span class="comment">;b8 ff ff ff ff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">rax</span>, -<span class="number">1</span>         <span class="comment">;48 c7 c0 ff ff ff ff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span>        <span class="comment">;31 c0</span></span><br><span class="line"><span class="keyword">dec</span> <span class="built_in">rax</span>             <span class="comment">;48 ff c8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">xor</span> <span class="built_in">ecx</span>, <span class="built_in">ecx</span>        <span class="comment">;31 c9</span></span><br><span class="line"><span class="keyword">lea</span> <span class="built_in">eax</span>, [<span class="built_in">rcx</span>-<span class="number">1</span>]    <span class="comment">;8d 41 ff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span> <span class="built_in">eax</span>, -<span class="number">1</span>          <span class="comment">;83 c8 ff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">push</span> -<span class="number">1</span>             <span class="comment">;6a ff</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">rax</span>             <span class="comment">;58</span></span><br></pre></td></tr></table></figure>
<p>从代码长度上来看，后两个无疑是最佳选择，但是牺牲了一部分性能。由于peter没有写benchmark，只是做了一些定性说明，所以我决定对性能做一个详细的测试。</p>
<blockquote>
<p>TL ; DR 选<code>mov</code>的两组。</p>
</blockquote>
<p><strong>To be continued.</strong></p>
<hr>
<h2 id="参考">参考</h2>
<div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://www.runoob.com/linux/linux-shell.html">Shell 教程</a></span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">2.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://www.cnblogs.com/alwaysking/p/12287529.html">NASM手册阅读笔记(8) - 其他</a></span><a href="#fnref:2" rev="footnote"> ↩</a></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">3.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://codegolf.stackexchange.com/questions/132981/tips-for-golfing-in-x86-x64-machine-code">Tips for golfing in x86/x64 machine code</a></span><a href="#fnref:3" rev="footnote"> ↩</a></li><li id="fn:4"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">4.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/21546946/what-does-p2align-do-in-asm-code">What does .p2align do in asm code?</a></span><a href="#fnref:4" rev="footnote"> ↩</a></li><li id="fn:5"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">5.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E26502_01/html/E28388/eoiyg.html">x86 Assembly Language Reference Manual</a></span><a href="#fnref:5" rev="footnote"> ↩</a></li><li id="fn:6"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">6.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/45105164/set-all-bits-in-cpu-register-to-1-efficiently">Set all bits in CPU register to 1 efficiently</a></span><a href="#fnref:6" rev="footnote"> ↩</a></li><li id="fn:7"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">7.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/33666617/what-is-the-best-way-to-set-a-register-to-zero-in-x86-assembly-xor-mov-or-and">What is the best way to set a register to zero in x86 assembly: xor, mov or and?</a></span><a href="#fnref:7" rev="footnote"> ↩</a></li><li id="fn:8"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">8.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://randomascii.wordpress.com/2012/12/29/the-surprising-subtleties-of-zeroing-a-register/">The Surprising Subtleties of Zeroing a Register</a></span><a href="#fnref:8" rev="footnote"> ↩</a></li><li id="fn:9"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">9.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://en.wikichip.org/wiki/intel/microarchitectures/skylake_(client)#:~:text=Those%20optimizations%20are%20done%20at%20the%20same%20rate%20as%20renaming%20during%20renaming%20(at%204%20%C2%B5OPs%20per%20cycle)%20and%20the%20register%20is%20simply%20set%20to%20zero.">skylake zeroing idioms</a></span><a href="#fnref:9" rev="footnote"> ↩</a></li><li id="fn:10"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">10.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/45105164/set-all-bits-in-cpu-register-to-1-efficiently">Set all bits in CPU register to 1 efficiently</a></span><a href="#fnref:10" rev="footnote"> ↩</a></li></ol></div></div></div><div class="article-licensing box"><div class="licensing-title"><p>一些汇编小技巧</p><p><a href="https://moep0.github.io/2021/11/29/一些汇编小技巧/">https://moep0.github.io/2021/11/29/一些汇编小技巧/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>moep0</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-11-29</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2021-11-29</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/assembly/">assembly</a><a class="link-muted mr-2" rel="tag" href="/tags/x86/">x86</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/11/11/%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E4%B8%80%E6%9D%A1%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4%E7%9A%84%E9%95%BF%E5%BA%A6/"><span class="level-item">如何确定一条汇编指令的长度</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://moep0.github.io/2021/11/29/%E4%B8%80%E4%BA%9B%E6%B1%87%E7%BC%96%E5%B0%8F%E6%8A%80%E5%B7%A7/';
            this.page.identifier = '2021/11/29/一些汇编小技巧/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'moep0-github-io' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://kw-20200521.oss-cn-beijing.aliyuncs.com/img/wallhaven-e73r98_3840x2160 (3).png" alt="moep0"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">moep0</p><p class="is-size-6 is-block">Student</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Somewhere</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">2</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/moep0" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/moep0"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Zhihu" href="https://zhihu.com"><i class="fab fa-zhihu"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="StackOverflow" href="https://stackoverflow.com/users/17187836/moep0"><i class="fab fa-stack-overflow"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#汇编预处理器指令（The-NASM-Preprocessor）"><span class="level-left"><span class="level-item">1</span><span class="level-item">汇编预处理器指令（The NASM Preprocessor）</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#rep指令"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">rep指令</span></span></a></li><li><a class="level is-mobile" href="#assign指令"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">assign指令</span></span></a></li><li><a class="level is-mobile" href="#实例"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">实例</span></span></a></li><li><a class="level is-mobile" href="#align-指令"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">align 指令</span></span></a></li><li><a class="level is-mobile" href="#comment"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">%comment</span></span></a></li></ul></li><li><a class="level is-mobile" href="#如何用shell脚本编译汇编程序"><span class="level-left"><span class="level-item">2</span><span class="level-item">如何用shell脚本编译汇编程序</span></span></a></li><li><a class="level is-mobile" href="#不知道该用在哪"><span class="level-left"><span class="level-item">3</span><span class="level-item">不知道该用在哪</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#初始化eax"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">初始化eax</span></span></a></li></ul></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">4</span><span class="level-item">参考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/howto/"><span class="level-start"><span class="level-item">howto</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/misc/"><span class="level-start"><span class="level-item">misc</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/tutorial/"><span class="level-start"><span class="level-item">tutorial</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-29T06:36:50.368Z">2021-11-29</time></p><p class="title"><a href="/2021/11/29/%E4%B8%80%E4%BA%9B%E6%B1%87%E7%BC%96%E5%B0%8F%E6%8A%80%E5%B7%A7/">一些汇编小技巧</a></p><p class="categories"><a href="/categories/howto/">howto</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-11T02:56:16.738Z">2021-11-11</time></p><p class="title"><a href="/2021/11/11/%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E4%B8%80%E6%9D%A1%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4%E7%9A%84%E9%95%BF%E5%BA%A6/">如何确定一条汇编指令的长度</a></p><p class="categories"><a href="/categories/howto/">howto</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-01T08:43:33.822Z">2021-11-01</time></p><p class="title"><a href="/2021/11/01/%E4%BD%BF%E7%94%A8%E6%B1%87%E7%BC%96%E7%BC%96%E5%86%99%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%A8%8B%E5%BA%8F/">使用汇编编写多线程程序</a></p><p class="categories"><a href="/categories/tutorial/">tutorial</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-29T06:56:04.947Z">2021-10-29</time></p><p class="title"><a href="/2021/10/29/hello-world/">Hello World</a></p><p class="categories"><a href="/categories/misc/">misc</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">October 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/assembly/"><span class="tag">assembly</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/x86/"><span class="tag">x86</span><span class="tag">3</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">MOEP0</a><p class="is-size-7"><span>&copy; 2021 moep0</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>